@attribute [Authorize(Roles="Administrator")]
@page "/document-templates"
@inject IDocumentTemplateService TemplateService
@inject IJSRuntime JsRuntime
@inject ISnackbar Snackbar
<RedirectToLogin />

<MudContainer Class="mt-4">
    <MudCard Class="mb-4">
        <MudCardHeader>
            <MudText Typo="Typo.h5">Шаблоны документов</MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Class="mb-3" OnClick="@(() => editor.Show())">Новый шаблон</MudButton>
            <MudTable Items="@items" Hover="true" Dense="true">
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Название</MudTh>
                    <MudTh Class="text-center">Действия</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">@context.Id</MudTd>
                    <MudTd DataLabel="Название">@context.Name</MudTd>
                    <MudTd DataLabel="Действия" Class="text-center">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => editor.Show(context.Id))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => Delete(context.Id))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudCardContent>
    </MudCard>

    <DocumentTemplateEditor @ref="editor" OnSaved="Load" />
</MudContainer>

@code {
    List<TemplateDto> items = new();
    DocumentTemplateEditor editor;

    protected override async Task OnInitializedAsync() => await Load();

    async Task Load() => items = await TemplateService.GetAllAsync();

    async Task Delete(int id)
    {
        if (!await JsRuntime.InvokeAsync<bool>("confirm", $"Удалить шаблон {id}?") )
            return;
        try
        {
            await TemplateService.DeleteAsync(id);
            Snackbar.Add("Шаблон удалён", Severity.Success);
            await Load();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Ошибка удаления: " + ex.Message, Severity.Error);
        }
    }
}
