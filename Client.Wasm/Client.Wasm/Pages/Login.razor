@page "/login"
@using Client.Wasm.Services
@layout LoginLayout
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider

<MudCard Class="pa-6" Style="width: 400px; box-shadow: 0 0 15px rgba(0,0,0,0.1);">
    <MudText Typo="Typo.h5" Class="mb-4">Вход</MudText>

    <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <MudTextField Label="Email"
                      @bind-Value="loginModel.Email"
                      For="@(() => loginModel.Email)"
                      Required="true"
                      RequiredError="Введите email"
                      Class="mb-3" />

        <MudTextField Label="Пароль"
                      InputType="InputType.Password"
                      @bind-Value="loginModel.Password"
                      For="@(() => loginModel.Password)"
                      Required="true"
                      RequiredError="Введите пароль"
                      Class="mb-3" />

        <MudButton Type="Submit" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true">
            Войти
        </MudButton>
    </EditForm>
</MudCard>

@code {
    LoginModel loginModel = new();

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLogin()
    {
        var dto = new Client.Wasm.DTOs.LoginRequestDto
        {
            Email = loginModel.Email,
            Password = loginModel.Password
        };
        var success = await AuthService.LoginAsync(dto);
        if (success)
            Navigation.NavigateTo("/");
    }

    class LoginModel
    {
        [Required]
        public string Email { get; set; }
        [Required]
        public string Password { get; set; }
    }
}
