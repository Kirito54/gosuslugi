@page "/login"
@layout LoginLayout
@inject Client.Wasm.Services.IAuthService AuthService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider

<MudCard Class="pa-6" Style="width: 400px; box-shadow: 0 0 15px rgba(0,0,0,0.1);">
    <MudText Typo="Typo.h5" Class="mb-4">Ð’Ñ…Ð¾Ð´</MudText>

    <EditForm Model="@loginModel" OnValidSubmit="HandleLogin" OnInvalidSubmit="HandleInvalidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <MudTextField @bind-Value="loginModel.Email" Label="Email" For="@(() => loginModel.Email)" />
        <MudTextField @bind-Value="loginModel.Password" Label="ÐŸÐ°Ñ€Ð¾Ð»ÑŒ" InputType="InputType.Password" For="@(() => loginModel.Password)" />

        <MudButton Variant="Variant.Filled" Color="Color.Primary" Type="Submit" FullWidth="true" OnClick="HanleLogin">
            Ð’Ð¾Ð¹Ñ‚Ð¸
        </MudButton>
    </EditForm>
</MudCard>

@code {
    LoginModel loginModel = new();

    private void HandleInvalidSubmit(EditContext context)
    {
        Console.WriteLine("âŒ ÐÐµÐ²Ð°Ð»Ð¸Ð´Ð½Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð°");
    }
    private async Task HandleLogin()
    {
        Console.WriteLine("HandleLogin called"); // ðŸ” Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ°

        var dto = new Client.Wasm.DTOs.LoginRequestDto
        {
            Email = loginModel.Email,
            Password = loginModel.Password
        };

        var success = await AuthService.LoginAsync(dto);
        if (success)
            Navigation.NavigateTo("/");
    }

    class LoginModel
    {
        [Required(ErrorMessage = "Email Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½")]
        public string Email { get; set; }

        [Required(ErrorMessage = "ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½")]
        public string Password { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated == true)
            Navigation.NavigateTo("/");
    }
    private void HanleLogin(MouseEventArgs args) => HandleLogin();
}
